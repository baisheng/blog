---
title: SQL 反模式-多值存储 (横穿马路)
date: 2018-09-24 23:20:00
tags: [数据库]
---

# 反模式

在存储一对多, 或者多对多的时候, 将相对应的项目使用数组的方式存储

| id   | name | friends |
| ---- | ---- | ------- |
| 1    | Bob  | 2,3     |
| 2    | Jack | 1,5     |
| 3    | Nina | 1       |
| 4    | Tina | 5       |
| 5    | Tom  | 4,2     |

# 缺点

1. 用一列来存储, 无法保证极端情况下长度永远足够
2. 如果要查找其中一个项目, 需要使用regex进行匹配, 不同数据库的regex的语法存在区别, 使sql语句的兼容性变差
3. 无法进行索引
4. 难以直接使用聚合函数, 如`SUM()`,`AVG()`,`COUNT()`
5. 如果想在一项里面删去一个值, 需要先取出, 再修改, 最后写回, 无法直接通过`update`或者`delete`进行更新
6. 因为填入数组, 需要指定字符串的类型, 难以约束内部数据的类型, 可能会出现`[1,2,3,banana]`的情况
7. 无法保证分隔符 (如`,`) 永远不会出现在内部一项数据里面, 列表中的某些条目可能会包含分隔符

# 解决方案

使用交叉表的形式进行存储, 相当于枚举所有的联系

上文的表就会变成

| id   | name |
| ---- | ---- |
| 1    | Bob  |
| 2    | Jack |
| 3    | Nina |
| 4    | Tina |
| 5    | Tom  |

| friend_left | friend_right |
| ----------- | ------------ |
| 1           | 2            |
| 1           | 3            |
| 2           | 1            |
| 2           | 5            |
| 3           | 1            |
| 4           | 5            |
| 5           | 4            |
| 5           | 2            |

通过另外一张表来表示用户之间的关系, 将数据和关系分离, 这样一来就可以非常容易地对关系进行管理

这种作法其实就是遵循`数据库规范化第四范式`, 消除多值依赖