<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nginx 反向代理配置 Github Page 的 api 网关 · SorcererXW's Blog</title><meta name="description" content="nginx 反向代理配置 Github Page 的 api 网关 - SorcererXW"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.sorcererxw.com/atom.xml" title="SorcererXW's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sorcererxw" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">nginx 反向代理配置 Github Page 的 api 网关</h1><div class="post-info">Aug 10, 2018</div><div class="post-content"><p>将 web app 部署在 Github Pages (以下简称 gp) 非常方便优雅, 但是会面临一个问题, 就是<strong>访问接口的跨域问题</strong>.</p>
<h1 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h1><p>通常, 我们直接将域名解析到 nginx 服务器, 再通过 nginx 反向代理, 将前端的 api 路径代理到 api 服务器上.<br>另一方面, 如果将项目部署在 gp 上面, 我们就需要将域名直接解析到 gp 服务器上.<br>这么一来, 两者就发生了冲突, 需要进行一些额外的配置.<br>那么, 我们索性将域名直接解析给 nginx, 然后通过 nginx 来将前端代理到 gp, api 代理到后端. 不过这么一来, 就没有遵循 gp 的配置规则, 无法启用 gp 的 enforce https 的功能, 不过这个跳转环节可以直接放在 nginx 上实现.</p>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先需要准备一台服务器, 然后安装启用 nginx, 将自己的所需要为前端配置的域名  <code>example.com</code> 解析到这台服务器上.<br>另外, 还需要配置好后端服务器, 并做好域名解析, 比如 <code>api.example.com</code></p>
<h2 id="部署-gh"><a href="#部署-gh" class="headerlink" title="部署 gh"></a>部署 gh</h2><p>参考 <a href="https://blog.sorcererxw.com/2018/08/09/%e8%ae%b0%e4%b8%80%e6%ac%a1-github-pages-%e9%83%a8%e7%bd%b2/">我之前的文章</a> 来部署好 gh, 并在自定义域名栏目里面填入 <code>example.com</code>, 由于解析地址的时候并没有解析到 gh, 所以看到 Enforce Https 无法勾选, 而且现在也无法进行访问.<br><img src="https://wx2.sinaimg.cn/mw690/86dfa6f4gy1fu4djg8ub3j20sc0m0gnn.jpg" alt="img"></p>
<h2 id="配置-nginx-反向代理"><a href="#配置-nginx-反向代理" class="headerlink" title="配置 nginx 反向代理"></a>配置 nginx 反向代理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123; </span><br><span class="line">    listen 80;</span><br><span class="line">    server_name example.com; # 填上自己的域名</span><br><span class="line">    location /api &#123; # 配置前端 api 的路径</span><br><span class="line">        proxy_pass https://api.example.com/; # 填上要转发的 api 服务器地址</span><br><span class="line">        # 这里有一个需要注意的地方如果填的是 https://api.xxxx.com (末尾无斜杠)</span><br><span class="line">        # 那么, 当前端访问 xxxx.com/api/target 时</span><br><span class="line">        # nginx 会将请求转发到 https://api.xxxx.com/api/target</span><br><span class="line">        # 而如果填的是 https://api.xxxx.com/</span><br><span class="line">        # 那么, 当前端访问 xxxx.com/api/target 时</span><br><span class="line">        # nginx 会将请求转发到 https://api.xxxx.com/target  </span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header host $host;</span><br><span class="line">        proxy_set_header x-real-ip $remote_addr;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass https://example.github.io;</span><br><span class="line">		# 填上你的 gp 的二级域名, 比如我的是 sorcererxw.github.io</span><br><span class="line">    &#125;</span><br><span class="line">    access_log /var/log/nginx/sorcererxw.com_access.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了, 然后重载一下 nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure></p>
<p>这个时候, 如果你访问 example.com 应该是可以访问了, 也能够在前端直接访问 api 接口.<br>原理就是, 虽然是直接将前端流量转发到 example.github.io, 但是通过当前地址栏当中的域名, gh 会显示为对应的前端页面.</p>
<h2 id="配置-Https-跳转"><a href="#配置-Https-跳转" class="headerlink" title="配置 Https 跳转"></a>配置 Https 跳转</h2><p>最方便的办法就是直接使用 letsencrypt 的 certbot 进行配置<br>根据 <a href="https://certbot.eff.org/" target="_blank" rel="noopener">https://certbot.eff.org/</a> 来进行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certbot --nginx</span><br></pre></td></tr></table></figure></p>
<p>记得选上 redirect https 即可.<br>当然, 如果有条件购买证书, 更加推荐使用.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/09/deploy-github-pags/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'sorcererxwblog';
var disqus_identifier = '2018/08/10/nginx-reverse-proxy-github-page-api-gateway/';
var disqus_title = 'nginx 反向代理配置 Github Page 的 api 网关';
var disqus_url = 'http://blog.sorcererxw.com/2018/08/10/nginx-reverse-proxy-github-page-api-gateway/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//sorcererxwblog.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://blog.sorcererxw.com">SorcererXW</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>